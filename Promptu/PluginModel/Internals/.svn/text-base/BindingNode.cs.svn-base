using System;
using System.Collections.Generic;
using System.Text;
using System.Reflection;

namespace ZachJohnson.Promptu.PluginModel.Internals
{
    internal class BindingNode
    {
        //private PropertyInfo propertyInfo;
        //private bool hasInitialized;
        private string propertyName;

        public BindingNode(string propertyName)
        {
            this.propertyName = propertyName;
        }

        public string PropertyName
        {
            get { return this.propertyName; }
        }

        public object GetValue(object context)
        {
            PropertyInfo propertyInfo = this.GetPropertyInfo(context);

            if (propertyInfo == null)
            {
                return null;
            }

            try
            {
                return propertyInfo.GetValue(context, null);
            }
            catch (MethodAccessException)
            {
            }
            catch (ArgumentException)
            {
            }
            catch (TargetInvocationException)
            {
            }
            catch (TargetException)
            {
            }
            catch (TargetParameterCountException)
            {
            }
            catch (InvalidCastException)
            {
            }

            return null;
        }

        public void SetValue(object context, object value)
        {
            PropertyInfo propertyInfo = this.GetPropertyInfo(context);

            if (propertyInfo == null)
            {
                return;
            }

            try
            {
                propertyInfo.SetValue(context, value, null);
            }
            catch (MethodAccessException)
            {
            }
            catch (ArgumentException)
            {
            }
            catch (TargetInvocationException)
            {
            }
            catch (TargetException)
            {
            }
            catch (TargetParameterCountException)
            {
            }
            catch (InvalidCastException)
            {
            }
        }

        private PropertyInfo GetPropertyInfo(object context)
        {
            if (context == null)
            {
                return null;
            }

            Type objectType = context.GetType();
            PropertyInfo propertyInfo = null;

            try
            {
                propertyInfo = objectType.GetProperty(
                    this.propertyName,
                    BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public);
            }
            catch (AmbiguousMatchException)
            {
            }

            return propertyInfo;
        }

        //protected override void SetValueCore(T value)
        //{
        //    lock (this)
        //    {
        //        if (this.dataContext == null)
        //        {
        //            return;
        //        }

        //        this.InitializeIfNecessary();

        //        if (this.propertyInfo == null)
        //        {
        //            return;
        //        }

        //        try
        //        {
        //            object setValue = value;

        //            if (this.typeConverter != null)
        //            {
        //                setValue = this.typeConverter.ConvertFrom(value);
        //            }

        //            this.propertyInfo.SetValue(this.dataContext, setValue, null);
        //        }
        //        catch (MethodAccessException)
        //        {
        //        }
        //        catch (ArgumentException)
        //        {
        //        }
        //        catch (TargetInvocationException)
        //        {
        //        }
        //        catch (TargetException)
        //        {
        //        }
        //        catch (TargetParameterCountException)
        //        {
        //        }
        //        catch (InvalidCastException)
        //        {
        //        }
        //    }
        //}

        //private void InitializeIfNecessary()
        //{
        //    if (!this.hasInitialized)
        //    {
        //        if (this.dataContext != null)
        //        {
        //            Type objectType = this.dataContext.GetType();
        //            try
        //            {
        //                this.propertyInfo = objectType.GetProperty(
        //                    this.path,
        //                    BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public);
        //            }
        //            catch (AmbiguousMatchException)
        //            {
        //            }
        //        }

        //        this.hasInitialized = true;
        //    }
        //}
    }
}
